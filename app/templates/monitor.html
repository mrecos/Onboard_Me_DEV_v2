<!-- templates/monitor.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Application Monitor</title>

  <!-- Include Bootstrap CSS -->
  <link 
    rel="stylesheet" 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  >
  <!-- Marked library for Markdown -> HTML conversion -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    #logOutput {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 1rem;
        border-radius: 0.25rem;
        height: 250px;
        overflow-y: auto;
        white-space: pre-wrap; 
      }
    #llmOutputList {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 1rem;
      border-radius: 0.25rem;
      height: 250px;
      overflow-y: auto;
    }
  </style>
</head>
<body class="bg-light">

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1">Rooty Monitor</span>
    </div>
  </nav>

  <div class="container">
    <!-- Row with 2 columns: Control panel & Logs -->
    <div class="row">
      <!-- Left column: Controls -->
      <div class="col-md-4 mb-3">
        <div class="card">
          <div class="card-header">
            <h5>Control Panel</h5>
          </div>
          <div class="card-body">
            <p>Trigger the <code>/initiate</code> endpoint with a user ID:</p>
            <div class="mb-3">
              <label for="userIdInput" class="form-label">User ID</label>
              <input 
                type="text" 
                id="userIdInput" 
                class="form-control" 
                placeholder="e.g. 123"
              >
            </div>
            <button class="btn btn-primary" id="initiateButton">
              Call /initiate
            </button>

            <hr>

            <p>Logs refresh every 5s, or click here:</p>
            <button class="btn btn-secondary" id="refreshLogsBtn">
              Refresh Logs
            </button>

            <hr>

            <p>LLM Output refresh every 5s, or click here:</p>
            <button class="btn btn-secondary" id="refreshLlmBtn">
              Refresh LLM Outputs
            </button>
          </div>
        </div>
      </div>

      <!-- Right column: Log display + LLM Output display -->
      <div class="col-md-8">
        <div class="row">
          <div class="col-12 mb-3">
            <div class="card">
              <div class="card-header">
                <h5>Live Logs</h5>
              </div>
              <div class="card-body">
                <div id="logOutput" class="small text-muted"></div>
              </div>
            </div>
          </div>
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h5>LLM Output History</h5>
              </div>
              <div class="card-body">
                <!-- We'll render each LLM markdown output as a block inside here -->
                <div id="llmOutputList"></div>
              </div>
            </div>
          </div>
        </div> <!-- /row -->
      </div>
    </div>
  </div>

  <script>
    /* ---------- Logs Section ---------- */
    function fetchLogs() {
        fetch('/logs')
          .then(response => response.json())
          .then(data => {
            const logOutput = document.getElementById('logOutput');
            // Join each log entry with a newline
            logOutput.textContent = data.join("\n");
            // Auto-scroll to bottom
            logOutput.scrollTop = logOutput.scrollHeight;
          })
          .catch(err => {
            console.error("Error fetching logs:", err);
          });
      }

    /* ---------- LLM Output Section ---------- */
    function fetchLlmOutputs() {
      fetch('/llm_outputs')
        .then(response => response.json())
        .then(data => {
          // data is an array of { timestamp, markdown }
          const container = document.getElementById('llmOutputList');
          container.innerHTML = ''; // Clear old contents

          data.forEach(entry => {
            // We can create a small wrapper for each LLM output
            const wrapper = document.createElement('div');
            wrapper.classList.add("mb-3", "p-2", "border", "rounded");

            // Create a heading for the timestamp
            const title = document.createElement('h6');
            title.textContent = `Timestamp: ${entry.timestamp}`;
            wrapper.appendChild(title);

            // Convert the markdown to HTML using 'marked'
            const renderedHtml = marked.parse(entry.markdown);
            
            // Create a div for the rendered content
            const markdownDiv = document.createElement('div');
            markdownDiv.innerHTML = renderedHtml;
            wrapper.appendChild(markdownDiv);

            container.appendChild(wrapper);
          });

          container.scrollTop = container.scrollHeight; // auto-scroll
        })
        .catch(err => {
          console.error("Error fetching LLM outputs:", err);
        });
    }

    /* ---------- Setup: Polling & Event Listeners ---------- */
    // Poll logs and LLM outputs every 5 seconds
    setInterval(fetchLogs, 5000);
    setInterval(fetchLlmOutputs, 5000);

    document.getElementById('refreshLogsBtn').addEventListener('click', fetchLogs);
    document.getElementById('refreshLlmBtn').addEventListener('click', fetchLlmOutputs);

    // On page load, fetch logs + LLM outputs
    fetchLogs();
    fetchLlmOutputs();

    // "Call /initiate" button
    document.getElementById('initiateButton').addEventListener('click', function() {
      const userIdValue = document.getElementById('userIdInput').value.trim();
      if (!userIdValue) {
        alert("Please enter a valid user ID.");
        return;
      }
      
      fetch(`/initiate?user_id=${encodeURIComponent(userIdValue)}`)
        .then(response => response.json())
        .then(data => {
          console.log("Response from /initiate:", data);
          alert(JSON.stringify(data));
          // Immediately refresh logs & LLM
          fetchLogs();
          fetchLlmOutputs();
        })
        .catch(error => {
          console.error("Error calling /initiate:", error);
        });
    });
  </script>
</body>
</html>
